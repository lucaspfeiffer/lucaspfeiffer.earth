<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Projects - Lucas Pfeiffer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
            transform-origin: center;
            transform: translateY(0);
            scroll-behavior: smooth;
        }

        .page-wrapper {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .content-wrapper {
            text-align: left;
            width: 100%;
            display: flex;
            flex-direction: column;
            flex: 1;
            padding: 0;
            padding-top: 0;
            padding-bottom: 0;
            height: 100vh; /* Fallback */
            height: 100dvh; /* Dynamic viewport height */
            overflow: hidden;
            position: relative;
        }

        .sticky-header {
            position: sticky;
            bottom: 0;
            background: #fff;
            z-index: 100;
            padding: 24px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            border-top: 1px solid #000;
            height: 80px;
            box-sizing: border-box;
            margin: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-right: auto; /* Push to the left like modal-title */
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-left: auto; /* Push to the right like modal-title */
        }

        .timeline-view {
            display: flex;
            flex-direction: row;
            overflow-x: auto;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            width: 100%;
            height: calc(100vh - 80px); /* Fallback */
            height: calc(100dvh - 80px); /* Dynamic viewport height */
            padding: 0 32px 96px 80px;
            flex: 1;
            scrollbar-width: none;
            overscroll-behavior-x: contain;
            cursor: grab;
            gap: 0;
            position: relative;
        }

        .sticky-header-wrapper {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            background: #fff;
            z-index: 1000;
            margin: 0;
            padding: 0;
            /* Ensure it stays above browser controls */
            padding-bottom: env(safe-area-inset-bottom, 0);
        }

        .main-content {
            padding: 0;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .current-year {
            font-size: 24px;
            color: #000;
            font-weight: 600; /* Match modal-title font weight */
            font-family: 'Inter', -apple-system, sans-serif;
            cursor: pointer;
            user-select: none;
        }

        .current-year:hover {
            text-decoration: none;
        }

        .header-right .current-year {
            color: #494949;
            text-decoration: none;
        }

        .header-right .current-year:hover {
            text-decoration: underline;
        }

        .year-section {
            flex: 0 0 auto;
            width: auto;
            position: relative;
            height: auto;
            overflow: visible;
            margin: 0;
            padding: 0;
        }

        /* Define CSS variables for consistent scaling */
        :root {
            --project-spacing: clamp(24px, 4vw, 60px);
            --image-scale: clamp(0.6, 0.7 + 0.3 * (100vw - 600px) / 1000, 1); /* Adjusted scaling for 600px breakpoint */
            --project-min-width: auto; /* Let images determine their natural width */
            --project-max-width: none; /* No artificial limitations */
        }
        
        .year-projects {
            display: flex;
            flex-direction: row;
            /* Spacing is handled by margins on child elements */
            gap: 0;
            padding: 0;
            align-items: center;
            justify-content: flex-start;
            min-width: min-content;
        }

        .project {
            flex: 0 0 auto;
            position: relative;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-width: var(--project-min-width);
            max-width: var(--project-max-width);
            /* Add consistent margin spacing instead of using gap */
            margin-right: var(--project-spacing);
            will-change: transform; /* Optimize for performance */
        }

        .project-image {
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 12px;
            overflow: visible;
            width: auto;
            height: auto;
            transform-origin: center center;
            transform: scale(var(--image-scale)); /* Proportionally scale with viewport */
            transition: transform 0.1s ease-out; /* Smoother scaling transitions */
            padding: 2px; /* Ensure no cutoff at edges */
        }

        .project-image img {
            height: auto;
            width: auto;
            max-height: 70vh; /* Limit height relative to viewport */
            object-fit: contain;
            display: block;
            border-radius: 12px;
            transition: opacity 0.2s ease; /* Fade in for better performance */
            object-position: center; /* Always center the image content */
        }
        
        /* Special styling for Dawn and Dusk project - use the same approach as other images */
        /* Dawn and Dusk will naturally hug its content with our new approach */

        /* Hide project content in main view */
        .timeline-view .project-content {
            display: none;
        }

        .project-content {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .project-title {
            font-size: 48px;
            color: #000;
            font-weight: 600;
            line-height: 1;
            font-family: 'Inter', -apple-system, sans-serif;
        }

        .project-description {
            font-size: 24px;
            color: #494949;
            font-weight: 500;
            line-height: 1.4;
            font-family: 'Inter', -apple-system, sans-serif;
        }

        .project-links {
            display: flex;
            gap: 24px;
        }

        .project-link {
            font-size: 24px;
            color: #000;
            font-weight: 500;
            text-decoration: underline;
            font-family: 'Inter', -apple-system, sans-serif;
        }

        /* Bottom navigation removed */

        /* Mobile adjustments - below 600px */
        @media (max-width: 599px) {
            /* Update CSS variables for mobile */
            :root {
                --project-spacing: clamp(20px, 3vw, 32px);
                --image-scale: clamp(0.45, 0.45 + 0.15 * (100vw - 320px) / 380, 0.6);
            }
            
            .sticky-header-wrapper {
                position: fixed;
                top: 0;
                bottom: auto;
                left: 0;
                right: 0;
                width: 100%;
                z-index: 1000;
                margin: 0;
                padding: 0;
                /* Ensure it stays above browser controls */
                padding-top: env(safe-area-inset-top, 0);
                padding-bottom: 0;
            }
            
            .sticky-header {
                position: sticky;
                top: 0;
                bottom: auto;
                padding: 24px;
                height: 80px;
                margin: 0;
                border-top: none;
                border-bottom: 1px solid #000;
            }
            
            .timeline-view {
                padding: 80px 24px 96px 12px; /* Increased bottom padding from 24px to 96px */
                height: calc(100vh - 80px); /* Fallback */
                height: calc(100dvh - 80px); /* Dynamic viewport height */
                margin-top: 0;
            }
            
            .year-section {
                padding: 0 16px;
            }

            .project-title {
                font-size: 24px;
            }

            .project-description {
                font-size: 17px;
            }

            .project-link {
                font-size: 17px;
            }

            .year-section {
                margin-bottom: 0;
            }

            .year-section:last-child {
                padding-bottom: 0;
            }

            .project {
                gap: 16px;
            }

            /* Bottom navigation CSS removed */

            .current-year {
                font-size: 17px;
            }

            .projects-table th {
                font-size: 14px;
                padding: 12px;
            }

            .projects-table td {
                font-size: 14px;
                padding: 16px 12px;
            }

            .timeline-view {
                grid-template-columns: 1fr;
                gap: 16px;
                padding: 0 24px 24px 12px; /* Mobile left padding reduced to 12px, bottom padding reduced */
            }

            .project-image {
                padding: 1px; /* Slightly smaller padding on mobile */
                transform: scale(0.85); /* Make images smaller on mobile */
            }
            
            .project-image img {
                max-height: 50vh; /* Reduce max height from 60vh to 50vh */
            }

            /* Year projects spacing is handled by margins on project elements */
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            height: 100vh; /* Fallback */
            height: 100dvh; /* Dynamic viewport height */
            background: #fff;
            z-index: 2000;
            visibility: hidden;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease-out, visibility 0.15s ease-out;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Set default flex order for all modal components */
        .modal-nav {
            order: 2; /* Navigation at the bottom by default */
        }
        
        .modal-content {
            order: 1; /* Content on top by default */
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            position: relative;
            height: calc(100vh - 80px); /* Fallback */
            height: calc(100dvh - 80px); /* Dynamic viewport height */
            padding-bottom: 96px;
        }

        .modal.active {
            visibility: visible;
            opacity: 1;
            pointer-events: all;
        }

        .modal-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 24px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-top: 1px solid #aaaaaa;
            background: #fff;
            z-index: 2001;
            height: 80px;
            box-sizing: border-box;
            width: 100%;
            /* Ensure it stays above browser controls */
            padding-bottom: calc(24px + env(safe-area-inset-bottom, 0));
        }

        .modal-nav-controls {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .modal-nav-button, .modal-close {
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            width: 52px;
            height: 52px;
            background: transparent;
            border-radius: 50%;
            transition: transform 0.1s ease-out; /* Snappy feedback when clicked */
        }
        
        .modal-nav-button:active, .modal-close:active {
            transform: scale(0.95); /* Slight scale down when clicked */
        }

        /* Hover effect removed */

        .modal-nav-button.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            pointer-events: none;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #000;
            margin-right: auto;
        }

        .modal-close {
            width: 52px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .modal-content-inner {
            opacity: 0;
            transition: opacity 0.15s ease-out;
            max-width: 890px;
            width: 100%;
            margin: 0 auto;
            padding: 32px;
            padding-bottom: 32px; /* Consistent padding at bottom */
            display: flex;
            flex-direction: column;
        }

        .modal.active .modal-content-inner {
            opacity: 1;
        }

        /* Override project styles when in modal */
        .modal-project {
            margin: 0;
            padding: 0;
            gap: 32px;
            flex: 1;
            display: flex;
            flex-direction: column;
            cursor: default;
        }

        .modal-project-image {
            margin: 0;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Change to top-align the image */
            overflow: visible;
            padding: 0;
            width: auto;
            height: 400px; /* Reduced from 480px to 400px */
            margin: 0 auto;
        }

        .modal-project-image img {
            width: auto;
            height: 100%;
            max-width: 100%;
            object-fit: contain;
            object-position: top; /* Ensure image is aligned to top */
            border-radius: 8px;
            transition: opacity 0.2s ease-out;
        }
        
        /* Special modal handling for Dawn and Dusk */
        .modal-content-inner [id="2025-dawn-and-dusk"] .modal-project-image img {
            height: auto;
            max-height: 70vh; /* Use viewport height for consistency */
            width: auto;
            max-width: 100%;
            padding: 8px;
            object-fit: contain;
        }

        .modal-project-title {
            font-size: 48px;
            color: #000;
            font-weight: 600;
            line-height: 1;
            font-family: 'Inter', -apple-system, sans-serif;
            margin-bottom: 32px;
            margin-left: 4px;
            min-height: 56px; /* Consistent height for title */
            transition: opacity 0.2s ease-out;
        }
        
        .modal-project-content {
            display: flex;
            flex-direction: column;
            gap: 32px; /* Restored original spacing */
            flex-grow: 1;
        }
        
        .modal-project-description {
            font-size: 24px;
            color: #494949;
            font-weight: 500;
            line-height: 1.4;
            font-family: 'Inter', -apple-system, sans-serif;
            transition: opacity 0.2s ease-out;
            margin: 0;
            padding: 0;
            height: auto;
            min-height: 0;
        }
        
        .modal-project-links {
            display: flex;
            gap: 24px;
            transition: opacity 0.2s ease-out;
            margin-top: 16px; /* Add specific top margin to control distance from description */
        }
        
        .modal-project-link {
            font-size: 24px;
            color: #000;
            font-weight: 500;
            text-decoration: underline;
            font-family: 'Inter', -apple-system, sans-serif;
        }

        
        /* Desktop layout - image on right */
        
        /* Desktop breakpoint (600px and up) */
        @media (min-width: 600px) {
            .modal-project {
                flex-direction: column;
                align-items: flex-start;
                gap: 32px;
            }
            
            .modal-project-title {
                width: 100%;
                margin-bottom: 24px;
            }
            
            .modal-project-content-wrapper {
                display: flex;
                flex-direction: row;
                width: 100%;
                gap: 48px;
                min-height: 0; /* Allow height to be determined by content */
                transition: opacity 0.2s ease-out;
                padding-top: 32px; /* Added top padding for desktop layout */
            }
            
            .modal-project-image {
                order: 0; /* Image on left */
                width: auto; /* Allow natural sizing */
                position: sticky;
                top: 112px; /* Nav height + some padding */
                align-self: flex-start;
                align-items: flex-start; /* Ensure top alignment in desktop view */
                border-radius: 8px;
                overflow: visible; /* Ensure image isn't cut off */
                margin-right: auto;
                max-width: 45%; /* Limit width to prevent oversized images */
            }
            
            .modal-project-image img {
                width: auto;
                max-width: 100%;
                max-height: 70vh; /* Slightly reduced for better fit */
                object-fit: contain;
                object-position: top; /* Consistent top alignment */
                display: block;
                border-radius: 8px;
                transition: opacity 0.15s ease-out; /* Smooth transitions */
            }
            
            .modal-project-content {
                order: 1; /* Content on right */
                width: 60%; /* Increased from 55% */
                padding-bottom: 64px;
                margin-bottom: 32px; /* Fixed margin to ensure content doesn't underlap the nav */
            }
            
            .modal-content-inner {
                padding: 48px;
                padding-left: calc(32px + min(160px, max(0px, 20vw - 120px))); /* More gradual reduction as viewport gets smaller */
                max-width: 1280px; /* Increased max-width for better use of screen space */
            }

            .modal-nav {
                order: 2; /* Keep navigation at bottom consistently */
                position: relative;
                border-top: 1px solid #aaaaaa;
                border-bottom: none;
            }
        }

        /* Mobile breakpoint (below 600px) */
        @media (max-width: 599px) {
            .modal-nav {
                padding: 24px;
                height: 80px; /* Match exactly with the timeline header */
                position: fixed;
                top: 0;
                bottom: auto;
                order: 0; /* Navigation at top for mobile */
                border-top: none;
                border-bottom: 1px solid #000; /* Match border color with timeline header */
                padding-top: calc(24px + env(safe-area-inset-top, 0));
                padding-bottom: 24px;
                box-sizing: border-box; /* Ensure padding is included in height */
            }
            
            .modal-title {
                font-size: 17px; /* Match the header year size on mobile */
            }
            
            .modal-nav-button, .modal-close {
                width: 44px;
                height: 44px;
            }
            
            .modal-nav-button svg, .modal-close svg {
                width: 24px;
                height: 24px;
            }
            
            .modal-nav-controls {
                gap: 16px;
            }

            .modal-content {
                height: calc(100vh - 80px);
                margin-top: 80px;
                order: 1; /* Content below navigation for mobile */
            }

            .modal-content-inner {
                padding: 24px 32px; /* Increased horizontal padding */
            }

            .modal-project {
                gap: 16px;
            }
            
            .modal-project-content {
                gap: 16px;
            }
            
            .modal-project-image img {
                max-height: 45vh; /* Simplified and slightly increased */
                margin-bottom: 8px;
                object-position: top; /* Ensure top alignment in mobile view */
                transition: opacity 0.15s ease-out; /* Added for smooth transitions */
            }
            
            /* Modal styling for Dawn and Dusk */
            .modal-content-inner [id="2025-dawn-and-dusk"] .modal-project-image img {
                max-height: 50vh; /* Match standard image height */
                padding: 4px;
                object-fit: contain;
                object-position: top; /* Ensure top alignment for special project */
            }
            
            .modal-project-title {
                font-size: 32px;
                margin-bottom: 24px;
                min-height: 36px; /* Adjusted for mobile font size */
            }
            
            .modal-project-description {
                font-size: 18px;
                margin: 0;
                padding: 0;
                height: auto;
                min-height: 0;
            }
            
            .modal-project-content-wrapper {
                min-height: 0; /* Allow height to be determined by content */
            }

            .modal-project-image {
                height: auto; /* Allow natural height */
                max-height: 50vh; /* Cap height */
                order: 1; /* Ensure image is first */
                overflow: visible; /* Ensure image isn't cut off */
                margin: 0 auto 16px; /* Center image */
            }
            
            .modal-project-link {
                font-size: 18px;
            }

            /* Adjust modal content wrapper for mobile */
            .modal-project-content-wrapper {
                display: flex;
                flex-direction: column;
                width: 100%;
                gap: 0; /* Remove gap for mobile */
            }

            .modal-project-content {
                order: 2; /* Move content below image */
                width: 100%;
                padding-bottom: 24px;
                margin-bottom: 24px; /* Added fixed margin for mobile to prevent content from underlapping nav */
            }

            .timeline-reference-marker {
                bottom: auto;
                top: calc(80px + env(safe-area-inset-top, 0)); /* Position fully below header */
                height: 16px;
                z-index: 1001;
            }

            .timeline-reference-marker::after {
                top: auto;
                bottom: -3.5px; /* Position dot at the bottom of the line */
                z-index: 1002; /* Ensure dot appears above the line */
            }
            
            /* Fix for timeline view to ensure content doesn't get hidden behind the header */
            .timeline-view {
                padding-top: 100px; /* Increase top padding to ensure content is visible below the header */
                padding-bottom: 24px; /* Reduce bottom padding since header is at top */
            }
            
            /* Ensure modal content doesn't get hidden behind the nav */
            .modal-content {
                padding-top: 24px;
                padding-bottom: 24px;
            }
            
            /* Ensure modal nav is always visible */
            .modal-nav {
                position: fixed;
                top: 0;
                bottom: auto;
                z-index: 2001;
                /* Ensure it stays above browser controls */
                padding-top: calc(24px + env(safe-area-inset-top, 0));
                padding-bottom: 24px;
                height: 80px; /* Match height with timeline header exactly */
                box-sizing: border-box; /* Ensure padding is included in height */
            }
        }

        /* Toggle button for timeline markers */
        .toggle-markers {
            display: none; /* Hide the toggle button */
        }
        
        /* Move timeline reference marker to bottom */
        .timeline-reference-marker {
            position: fixed;
            width: 1.5px;
            background-color: #888;
            z-index: 1001;
            pointer-events: none;
            transition: left 0.3s ease;
            bottom: calc(80px + env(safe-area-inset-bottom, 0));
            height: 16px;
        }
        
        /* Add a dot at the top of the line */
        .timeline-reference-marker::after {
            content: '';
            display: block;
            position: absolute;
            width: 7px;
            height: 7px;
            background-color: #CC5500;
            border-radius: 50%;
            top: -3.5px;
            left: -2.75px;
        }

        .timeline-reference-marker::before,
        .timeline-reference-marker span {
            display: none;
        }

        /* Mobile-specific timeline marker styling */
        @media (max-width: 599px) {
            .timeline-reference-marker {
                bottom: auto;
                top: calc(80px + env(safe-area-inset-top, 0));
                height: 16px;
            }

            .timeline-reference-marker::after {
                top: auto;
                bottom: -3.5px;
            }
        }

        @supports (-webkit-touch-callout: none) {
            /* iOS-specific fixes */
            .content-wrapper,
            .timeline-view,
            .modal,
            .modal-content {
                /* Use -webkit-fill-available as a fallback for older iOS */
                height: -webkit-fill-available;
            }
            
            .timeline-view,
            .modal-content {
                height: calc(-webkit-fill-available - 80px);
            }
            
            /* Fix iOS safe area inset handling */
            @media (min-width: 600px) {
                .sticky-header-wrapper {
                    background: #fff;
                    padding-bottom: env(safe-area-inset-bottom, 0);
                }
                
                .modal-nav {
                    background: #fff;
                    padding-bottom: calc(24px + env(safe-area-inset-bottom, 0));
                }
            }
            
            @media (max-width: 599px) {
                .sticky-header-wrapper {
                    background: #fff;
                    padding-top: env(safe-area-inset-top, 0);
                    padding-bottom: 0;
                }
                
                .modal-nav {
                    background: #fff;
                    padding-top: calc(24px + env(safe-area-inset-top, 0));
                    padding-bottom: 24px;
                }
                
                /* Move the dot to the bottom of the line on mobile */
                .timeline-reference-marker::after {
                    top: auto;
                    bottom: -3.5px; /* Position dot at the bottom of the line */
                }
            }
        }

        @media (min-width: 600px) {
            .timeline-reference-marker::after {
                width: 10px;
                height: 10px;
                top: -5px;
                left: -4px;
            }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <div class="content-wrapper">
            <div class="main-content">
                <div class="timeline-view">
                    <!-- Projects will be dynamically inserted here -->
                </div>
                <!-- Single fixed reference marker -->
                <div class="timeline-reference-marker">
                    <span class="top-label">← Updates Year →</span>
                </div>
            </div>
        </div>
        <div class="sticky-header-wrapper">
            <div class="sticky-header">
                <div class="header-left">
                    <div class="current-year">2024</div>
                </div>
                <div class="header-right">
                    <a href="https://lucaspfeiffer.earth" class="current-year">Lucas</a>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="project-modal">
        <nav class="modal-nav">
            <div class="modal-title"></div>
            <div class="modal-nav-controls">
                <div class="modal-nav-button prev-project" id="prev-project-btn">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 18L9 12L15 6" stroke="black" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div class="modal-nav-button next-project" id="next-project-btn">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 18L15 12L9 6" stroke="black" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div class="modal-nav-button modal-close" id="modal-close-btn">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 6L6 18M6 6L18 18" stroke="black" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
            </div>
        </nav>
        <div class="modal-content">
            <div class="modal-content-inner"></div>
        </div>
    </div>

    <script src="projects.js"></script>
    <script>
        function updateHeaderAndShadows() {
            const timelineView = document.querySelector('.timeline-view');
            const currentYearElement = document.querySelector('.current-year');
            
            // Get the position of the reference line for year detection
            const referenceLine = document.querySelector('.timeline-reference-marker').getBoundingClientRect().left;
            
            // Find the project that first touches or crosses the reference line
            const projects = document.querySelectorAll('.project');
            let currentProject = null;
            let minDistance = Infinity;
            
            projects.forEach(project => {
                const rect = project.getBoundingClientRect();
                // Get the left edge of the project
                const projectLeft = rect.left;
                // Calculate distance to the reference line
                const distanceToLine = projectLeft - referenceLine;
                
                // We want the project that's closest to the line from the right side (approaching the line)
                // Or the project that has just started to cross the line (negative distance)
                // Projects that have completely crossed the line will have large negative distances
                if ((distanceToLine <= 0 && distanceToLine > -rect.width) || 
                    (distanceToLine > 0 && distanceToLine < 200)) {
                    // Project is near or just starting to cross the line
                    if (Math.abs(distanceToLine) < minDistance) {
                        minDistance = Math.abs(distanceToLine);
                        currentProject = project;
                    }
                }
            });
            
            // If found a project close to the reference line, update the year
            if (currentProject) {
                // Extract the year from the project ID (format: "2024-project-name")
                const projectId = currentProject.id;
                const projectYear = projectId.split('-')[0];
                
                // Update the year in the header if it changed
                if (projectYear && currentYearElement.textContent !== projectYear) {
                    currentYearElement.textContent = projectYear;
                    currentYearElement.setAttribute('data-year', projectYear);
                    
                    // Year links removed
                    
                    // Re-align the timeline with the newly updated year
                    alignTimelineWithYear();
                }
            }
        }

        function renderProjects() {
            const timelineView = document.querySelector('.timeline-view');
            
            // Clear existing content
            timelineView.innerHTML = '';
            
            // Get unique years and sort them in descending order
            const years = [...new Set(projects.map(p => p.year))].sort((a, b) => b - a);
            
            // Create a single container for all projects
            const projectsContainer = document.createElement('div');
            projectsContainer.className = 'year-projects';
            projectsContainer.style.display = 'flex';
            projectsContainer.style.flexDirection = 'row';
            // Using CSS variables for consistent spacing - no need to set gap here
            projectsContainer.style.width = '100%';
            
            // Sort all projects by year (descending) and then by month (descending)
            const sortedProjects = [...projects].sort((a, b) => {
                if (a.year !== b.year) return b.year - a.year;
                return b.month - a.month;
            });
            
            // Add year markers for navigation
            let currentYear = null;
            let yearProjectStart = {};
            let yearCount = 0;
            
            // First pass - create all projects and collect first project of each year
            sortedProjects.forEach((project, index) => {
                // If this is a new year, remember the index of the first project for this year
                if (project.year !== currentYear) {
                    currentYear = project.year;
                    yearProjectStart[project.year] = index;
                    yearCount++;
                    
                    // Create an invisible year marker div for navigation only
                    const yearMarker = document.createElement('div');
                    yearMarker.id = project.year;
                    yearMarker.style.position = 'absolute';
                    yearMarker.style.opacity = '0';
                    yearMarker.style.pointerEvents = 'none';
                    yearMarker.style.zIndex = '-1';
                    
                    // Important: Position the year marker at the LEFT EDGE of the first project of the year
                    // This ensures the year updates when the project crosses the reference line
                    if (index > 0) {
                        yearMarker.setAttribute('data-is-year-start', 'true');
                    }
                    
                    projectsContainer.appendChild(yearMarker);
                }
                
                // Create project element
                const projectElement = document.createElement('div');
                projectElement.id = `${project.year}-${project.id}`;
                
                // Add project class and handle last item's margin
                const isLastProject = index === sortedProjects.length - 1;
                projectElement.className = 'project';
                
                // No right margin needed for the last project
                if (isLastProject) {
                    projectElement.style.marginRight = '0';
                }
                projectElement.innerHTML = `
                    <div class="project-image">
                        <img src="${project.image}" alt="${project.title}" />
                    </div>
                    <div class="project-content">
                        <h2 class="project-title">${project.title}</h2>
                        <p class="project-description">${project.description}</p>
                        <div class="project-links">
                            ${project.links.map(link => `
                                <a href="${link.url}" class="project-link" target="_blank">${link.text}</a>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                projectsContainer.appendChild(projectElement);
            });
            
            // Add all projects to timeline view
            timelineView.appendChild(projectsContainer);
            
            // Position year markers correctly - after all projects are rendered and sized
            setTimeout(() => {
                positionYearMarkers();
            }, 100);
            
            // Reattach event listeners
            attachEventListeners();
        }
        
        // Function to accurately position year markers
        function positionYearMarkers() {
            // Get all projects and markers
            const projects = document.querySelectorAll('.project');
            const yearMarkers = document.querySelectorAll('[id^="20"]');
            const timelineView = document.querySelector('.timeline-view');
            
            // For each year, find its first project and position the marker at its left edge
            yearMarkers.forEach(marker => {
                // Skip if not a pure year marker
                if (marker.id.includes('-')) return;
                
                const year = marker.id;
                const firstYearProject = document.querySelector(`[id^="${year}-"]`);
                
                if (firstYearProject) {
                    // Get the left edge position of the first project of this year
                    const projectRect = firstYearProject.getBoundingClientRect();
                    const timelineRect = timelineView.getBoundingClientRect();
                    
                    // Position the marker at the LEFT edge of the first project
                    // This ensures the year updates precisely when the project crosses the reference line
                    const leftPosition = projectRect.left - timelineRect.left + timelineView.scrollLeft;
                    marker.style.left = `${leftPosition}px`;
                }
            });
        }

        function attachEventListeners() {
            // Project click handlers
            document.querySelectorAll('.project').forEach(project => {
                project.addEventListener('click', (e) => {
                    if (e.target.closest('.project-link')) return;
                    console.log('Project clicked:', project.id);
                    openModal(project);
                });
            });

            // Year link handlers removed
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            renderProjects();
            
            // Set initial current year to most recent year (first in the list)
            const years = [...new Set(projects.map(p => p.year))].sort((a, b) => b - a);
            if (years.length > 0) {
                document.querySelector('.current-year').textContent = years[0];
                
                // Auto-scroll to first year section (slight delay to let rendering complete)
                setTimeout(() => {
                    const firstYearSection = document.getElementById(years[0]);
                    if (firstYearSection) {
                        const timelineView = document.querySelector('.timeline-view');
                        timelineView.scrollTo({
                            left: 0,
                            behavior: 'auto'
                        });
                    }
                    updateHeaderAndShadows();
                    alignTimelineWithYear();
                }, 100);
            }
            
            // Make current year clickable to open a menu on mobile
            document.querySelector('.current-year').addEventListener('click', function() {
                // Scroll to the year marker
                const year = this.textContent;
                const yearMarker = document.getElementById(year);
                if (yearMarker) {
                    // Get the marker position
                    const timelineView = document.querySelector('.timeline-view');
                    const markerRect = yearMarker.getBoundingClientRect();
                    
                    // Calculate the target scroll position
                    const targetScrollLeft = timelineView.scrollLeft + markerRect.left - (window.innerWidth <= 700 ? 12 : 80); // Adjust for padding
                    
                    // Scroll to the first project of that year
                    timelineView.scrollTo({
                        left: targetScrollLeft,
                        behavior: 'smooth'
                    });
                }
            });
            
            // Add touch-friendly drag scrolling for desktop
            const timelineView = document.querySelector('.timeline-view');
            let isDown = false;
            let startX;
            let scrollLeft;

            timelineView.addEventListener('mousedown', (e) => {
                isDown = true;
                timelineView.style.cursor = 'grabbing';
                startX = e.pageX - timelineView.offsetLeft;
                scrollLeft = timelineView.scrollLeft;
            });

            timelineView.addEventListener('mouseleave', () => {
                isDown = false;
                timelineView.style.cursor = 'grab';
            });

            timelineView.addEventListener('mouseup', () => {
                isDown = false;
                timelineView.style.cursor = 'grab';
            });

            timelineView.addEventListener('mousemove', (e) => {
                if(!isDown) return;
                e.preventDefault();
                const x = e.pageX - timelineView.offsetLeft;
                const walk = (x - startX) * 2; // Scroll multiplier
                timelineView.scrollLeft = scrollLeft - walk;
                updateHeaderAndShadows();
                alignTimelineWithYear();
            });
            
            // Ensure the timeline view updates on scroll
            timelineView.addEventListener('scroll', () => {
                requestAnimationFrame(() => {
                    updateHeaderAndShadows();
                    alignTimelineWithYear();
                });
            });
            
            // Initial alignment
            alignTimelineWithYear();
        });
        
        // Function to align timeline marker with the center of the current year text
        function alignTimelineWithYear() {
            const currentYearElement = document.querySelector('.current-year');
            const timelineMarker = document.querySelector('.timeline-reference-marker');
            
            if (currentYearElement && timelineMarker) {
                const yearRect = currentYearElement.getBoundingClientRect();
                // Calculate center position of the year text
                const centerPosition = yearRect.left + yearRect.width / 2;
                
                // Set the timeline marker to align with the center of the year text
                timelineMarker.style.left = `${centerPosition}px`;
            }
        }
        
        // Handle resize events
        window.addEventListener('resize', () => {
            updateHeaderAndShadows();
            alignTimelineWithYear();
            
            // Reposition all year markers when window size changes
            setTimeout(() => {
                positionYearMarkers();
            }, 100);
        });

        // Modal functionality
        let currentlyLoadingProject = false;
        let safetyTimeout = null;

        // Maximum allowed time for a modal transition (ms)
        const MAX_TRANSITION_TIME = 1500;
        
        // Function to safely reset loading state if it gets stuck
        function ensureLoadingStateReset() {
            // Clear any existing timeout
            if (safetyTimeout) {
                clearTimeout(safetyTimeout);
            }
            
            // Set new safety timeout
            safetyTimeout = setTimeout(() => {
                if (currentlyLoadingProject) {
                    console.log('Safety: Resetting stuck loading state');
                    currentlyLoadingProject = false;
                }
            }, MAX_TRANSITION_TIME);
        }

        function openModal(projectElement, isNavigating = false) {
            // Prevent multiple operations at once
            if (currentlyLoadingProject) {
                return;
            }
            
            currentlyLoadingProject = true;
            
            // Get all required elements
            const modal = document.getElementById('project-modal');
            const modalContent = modal.querySelector('.modal-content-inner');
            const modalTitle = modal.querySelector('.modal-title');
            const modalContentElement = modal.querySelector('.modal-content');
            const prevButton = document.getElementById('prev-project-btn');
            const nextButton = document.getElementById('next-project-btn');
            
            // Save current scroll position if not navigating
            if (!isNavigating) {
                savedScrollPosition = window.scrollY;
            }
            
            // Get project data directly from the source
            const parts = projectElement.id.split('-');
            const year = parseInt(parts[0], 10);
            const id = parts.slice(1).join('-');
            
            // Find the project by both year and id
            const projectData = projects.find(p => p.id === id && p.year === year);
            
            // Set up navigation
            const allProjects = Array.from(document.querySelectorAll('.project'));
            const currentIndex = allProjects.indexOf(projectElement);
            
            prevButton.classList.toggle('disabled', currentIndex === 0);
            nextButton.classList.toggle('disabled', currentIndex === allProjects.length - 1);
            
            // Setup navigation buttons
            prevButton.onclick = () => {
                if (currentIndex > 0 && !currentlyLoadingProject) {
                    openModal(allProjects[currentIndex - 1], true);
                }
            };
            
            nextButton.onclick = () => {
                if (currentIndex < allProjects.length - 1 && !currentlyLoadingProject) {
                    openModal(allProjects[currentIndex + 1], true);
                }
            };
            
            // Prepare content
            let modalHTML = '';
            
            if (!projectData) {
                console.error('Project data not found. ID:', id, 'Year:', year);
                
                // Fallback to DOM content
                const descElement = projectElement.querySelector('.project-description');
                const imgElement = projectElement.querySelector('.project-image img');
                
                if (descElement && imgElement) {
                    modalTitle.textContent = year;
                    
                    modalHTML = `
                        <div class="modal-project">
                            <div class="modal-project-content-wrapper">
                                <div class="modal-project-image">
                                    <img src="${imgElement.src}" alt="${imgElement.alt || ''}" loading="eager" />
                                </div>
                                <div class="modal-project-content">
                                    <p class="modal-project-description">${descElement.innerHTML}</p>
                                    <div class="modal-project-links">
                                        ${projectElement.querySelector('.project-links')?.innerHTML || ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    currentlyLoadingProject = false;
                    return;
                }
            } else {
                modalTitle.textContent = projectData.year;
                
                modalHTML = `
                    <div class="modal-project">
                        <div class="modal-project-content-wrapper">
                            <div class="modal-project-image">
                                <img src="${projectData.image}" alt="${projectData.title}" loading="eager" />
                            </div>
                            <div class="modal-project-content">
                                <p class="modal-project-description">${projectData.description}</p>
                                <div class="modal-project-links">
                                    ${projectData.links.map(link => `
                                        <a href="${link.url}" class="modal-project-link" target="_blank">${link.text}</a>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Function to apply content after image is loaded
            const applyContent = () => {
                modalContent.style.opacity = '0';
                
                setTimeout(() => {
                    modalContent.innerHTML = modalHTML;
                    
                    // Reset scroll position
                    modalContentElement.scrollTop = 0;
                    
                    // Show modal if not already shown
                    if (!modal.classList.contains('active')) {
                        document.body.style.overflow = 'hidden';
                        modal.classList.add('active');
                    }
                    
                    // Fade in content
                    requestAnimationFrame(() => {
                        modalContent.style.opacity = '1';
                        currentlyLoadingProject = false;
                    });
                }, isNavigating ? 150 : 0);
            };
            
            // Preload image
            const tempImg = new Image();
            tempImg.onload = applyContent;
            tempImg.onerror = applyContent; // Still show content even if image fails
            tempImg.src = projectData ? projectData.image : projectElement.querySelector('.project-image img').src;
        }

        function closeModal() {
            if (currentlyLoadingProject) return;
            
            const modal = document.getElementById('project-modal');
            const modalContent = modal.querySelector('.modal-content-inner');
            
            // Fade out content first
            modalContent.style.opacity = '0';
            
            setTimeout(() => {
                modal.classList.remove('active');
                document.body.style.overflow = '';
                window.scrollTo(0, savedScrollPosition);
                
                // Clean up content after transition
                setTimeout(() => {
                    modalContent.innerHTML = '';
                }, 150);
            }, 150);
        }

        // Add savedScrollPosition variable
        let savedScrollPosition = 0;

        // Remove the vertical-to-horizontal scroll conversion for better stability
        document.getElementById('modal-close-btn').addEventListener('click', closeModal);
        
        // Test function for debugging
        window.testModal = function() {
            console.log('Testing modal');
            const modal = document.getElementById('project-modal');
            modal.classList.toggle('active');
            if (modal.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
            console.log('Modal classes:', modal.className);
            return 'Modal test complete';
        };
        
        // Enhanced keyboard navigation with debouncing
        let keyNavigationTimeout = null;
        document.addEventListener('keydown', (e) => {
            const modal = document.getElementById('project-modal');
            const isModalActive = modal.classList.contains('active');
            
            // Only process if modal is active and not in a loading state
            if (!isModalActive || currentlyLoadingProject) return;
            
            // Use a simpler debounce approach
            if (keyNavigationTimeout) {
                clearTimeout(keyNavigationTimeout);
            }
            
            // Very short debounce time for responsive feel
            keyNavigationTimeout = setTimeout(() => {
                keyNavigationTimeout = null;
                
                switch (e.key) {
                    case 'Escape':
                        e.preventDefault();
                        closeModal();
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        const prevButton = document.getElementById('prev-project-btn');
                        if (!prevButton.classList.contains('disabled')) {
                            prevButton.click();
                        }
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        const nextButton = document.getElementById('next-project-btn');
                        if (!nextButton.classList.contains('disabled')) {
                            nextButton.click();
                        }
                        break;
                }
            }, 50); // Very short debounce for responsive feel
        });

        // Helper function to calculate year marker position
        function calculateYearPosition(index) {
            const isMobile = window.innerWidth <= 700;
            const isTablet = window.innerWidth <= 1024 && window.innerWidth > 700;
            
            // Base position calculation using viewport-relative values
            let position;
            
            if (isMobile) {
                position = `${index * 80 + 12}px`;
            } else if (isTablet) {
                position = `${index * 100 + 24}px`;
            } else {
                position = `${index * 120 + 80}px`;
            }
            
            return position;
        }
    </script>
</body>
</html> 