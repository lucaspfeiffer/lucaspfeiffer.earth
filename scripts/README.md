# Nostr Photo Sync Scripts

Automatically fetches photos from your Nostr account, converts them to WebP format, and updates your website's photos page.

## Features

- üì° **Fetches photos from Nostr** - Connects to Nostr relays via WebSocket to get your latest posts with images
- üé® **WebP conversion** - Automatically converts JPEG/PNG images to optimized WebP format (8-62% size reduction)
- üîÑ **Deduplication** - Tracks processed photos to avoid duplicates
- üìù **Auto-updates HTML** - Updates your photos.html page with new images and metadata
- ü§ñ **GitHub Actions** - Runs automatically twice daily via GitHub Actions

## Setup

1. **Install dependencies:**
   ```bash
   cd scripts
   npm install
   ```

2. **Update your Nostr pubkey** in `fetch-nostr-photos.js` (line 165)

3. **Enable GitHub Actions** by pushing the `.github/workflows/` files to your repository

## Manual Usage

### Fetch new photos
```bash
npm start
# or
node fetch-nostr-photos.js
```

### Convert existing images to WebP
```bash
node convert-existing.js
```

### Update paths after manual WebP conversion
```bash
node update-webp-paths.js
```

## How it works

1. **Connects to Nostr relay** (`wss://relay.damus.io`)
2. **Fetches recent posts** (kinds 1 and 20) from your pubkey
3. **Extracts image URLs** from post content and `imeta` tags
4. **Downloads images** to the `images/` directory
5. **Converts to WebP** using Sharp image processing
6. **Updates photos.html** with the new photo data
7. **Saves state** to avoid processing duplicates

## File Structure

- `fetch-nostr-photos.js` - Main script that orchestrates the entire process
- `nostr-websocket.js` - WebSocket client for connecting to Nostr relays
- `npub-decoder.js` - Converts npub (bech32) format to hex pubkey
- `image-optimizer.js` - WebP conversion using Sharp
- `processed-photos.json` - State file tracking processed photos
- `convert-existing.js` - One-time script to convert existing images
- `update-webp-paths.js` - Updates photo paths after conversion

## Configuration

### Supported Image Hosts
- image.nostr.build
- nostr.build  
- cdn.satellite.earth
- void.cat
- i.imgur.com
- primal.net/api/media

### WebP Quality
Default: 80% (configurable in `image-optimizer.js`)

## GitHub Actions

Two workflows are provided:

### `sync-nostr.yml` (Recommended)
- Runs twice daily (6 AM & 6 PM UTC)
- Fetches photos, converts to WebP, commits changes
- Simple and reliable

### `nostr-photos.yml` (Advanced)  
- Uses Calibre Image Actions for optimization
- Separate optimization job
- More complex deployment process

## Troubleshooting

### No photos found
- Verify your npub is correct
- Check if you have recent posts with images on Nostr
- Try different relay (edit `fetch-nostr-photos.js` line 169)

### WebP conversion fails
- Ensure Sharp is installed: `npm install sharp`
- Check image file permissions
- Verify source images exist

### GitHub Actions not running
- Enable Actions in repository settings
- Check workflow permissions in `.github/workflows/`
- Verify `secrets.GITHUB_TOKEN` is available

## Generated by Claude Code

This entire pipeline was built end-to-end by [Claude Code](https://claude.ai/code) ü§ñ